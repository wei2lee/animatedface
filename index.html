<!DOCTYPE html>
<html>
    <script src="js/jquery-2.0.0.min.js"></script>
    <script src="js/jquery.json-2.4.js"></script>
    <script src="js/sprintf-0.7-beta1.js"></script>
    <script src="js/threejs/build/three.js"></script>
    <script src="js/Stats.js"></script>
    <script src="js/sprintf.min.js"></script>
    <!--
	<link href='http://fonts.googleapis.com/css?family=Noto+Serif' rel='stylesheet' type='text/css'>
    <link href='http://fonts.googleapis.com/css?family=Open+Sans' rel='stylesheet' type='text/css'>
    -->
	
	<script src="js/threejs/examples/js/renderers/CSS3DRenderer.js"></script>
    
    <link href='http://reset5.googlecode.com/hg/reset.min.css' rel='stylesheet' type='text/css'>

    
	<link rel="stylesheet" href="http://code.jquery.com/ui/1.10.2/themes/smoothness/jquery-ui.css" />
	<script src="http://code.jquery.com/jquery-1.9.1.js"></script>
	<script src="http://code.jquery.com/ui/1.10.2/jquery-ui.js"></script>
	<style>
		* {
			font-family: 'Open Sans', sans-serif;
			font-size: 15px;
			line-height:17px;
			
		}
		
		body {
			margin: 10px;
		}
	
        canvas {
            border:1px solid #cccccc;
            margin:5px 0 0 0;
            
        }
		
		
		.dialog {
            background-color:#fbfbfb;
            position:relative;
            min-height:150px;
			padding:4px 2px 2px 6px;
			width:460px;
			border:1px solid #cccccc;
			margin:5px 0 0 0;
			box-sizing: border-box;
			-moz-user-select: none; 
			-khtml-user-select: none; 
			-webkit-user-select: none; 
			-o-user-select: none; 
		}
        
        #log {
            min-height:0px;
			-moz-user-select: none; 
			-khtml-user-select: none; 
			-webkit-user-select: none; 
			-o-user-select: none; 
        }
		
		#btnnext {
            position:absolute;
            bottom:5px;
            right:5px;
			float:right;
			width:100px;
			height:30px;
			
		}
        
        #fps_stats {
            position:absolute;
            top:5px;
            right:85px;
        }
        
        
		
		.clear {
			clear:both;
		}
		

} 
    </style>
    
	
	
    <body id=body></body>
	
	<div class=dialog>
	<div id=instruction></div>
	<input type=button id=btnnext value=Next>	
	<div class=clear></div>
	</div>
    
    <div class=dialog>
        <div id=log></div>
        <div id=fps_stats></div>
    </div>
    
    
</html>
    
<script>
    THREE.Face3.prototype.set = function(a,b,c) {
        this.a=a;
        this.b=b;
        this.c=c;
    };
    
    THREE.Face4.prototype.set = function(a,b,c,d) {
		if(a instanceof THREE.Face4) {
			this.a=a.a;
			this.b=a.b;
			this.c=a.c;
			this.d=a.d;
		} else {
			this.a=a;
			this.b=b;
			this.c=c;
			this.d=d;
		}
    };
    
    THREE.Object3D.prototype.hitTestRect = function(lb, up) {
        return false;   
    }
    
    THREE.Object3D.prototype.hitTest = function(p) {
        return false;   
    }

	var Renderer2d = function(param){
		THREE.CanvasRenderer.call(this, param);
	};
	Renderer2d.prototype = Object.create( THREE.CanvasRenderer.prototype );

	
	
    function rand() { return Math.random(); }
    function inrng(val,lb,up) { return lb  <= val && val <= up; }
    function calFVUVs(geo) {
        
        if(geo.faceVertexUvs[0].length > 0) {
        
            for (i = 0; i < geo.faceVertexUvs[0].length; i++) {
                for (j = 0; j < geo.faceVertexUvs[0][i].length; j++) {
                    uv = geo.faceVertexUvs[0][i][j];
                    uv.x = uv.x / f.img.b.w + 0.5;
                    uv.y = uv.y / f.img.b.h + 0.5;
                }
            }
                
        } else {
            for (i = 0; i < geo.faces.length ; i++) {
                geo.faceVertexUvs[0].push([]);
                for(j = 0; j < 4; j++) {
                    vt = null;
                    if(j == 0) vt = geo.vertices[geo.faces[i].a];   
                    if(j == 1) vt = geo.vertices[geo.faces[i].b];   
                    if(j == 2) vt = geo.vertices[geo.faces[i].c];   
                    if(j == 3 && geo.faces[i].hasOwnProperty('d')) vt = geo.vertices[geo.faces[i].d];   
                    
                    if(vt) {
                        uv = new THREE.Vector2(vt.x / f.img.b.w + 0.5, vt.y / f.img.b.h + 0.5);
                        geo.faceVertexUvs[0][i].push(uv);
                    }
                }
            }
        }
    }
	
	
	var f = {
		img: {
			src:'images/monalisa.jpg',
			dom:null,
			b:{x:0, y:0, w:0, h:0}
		}
	
	};
	
	var app = {
		st: null,
		setSt: function(st) {
			if(this.st == st) return;
			this.st = st;
			
			if(st == 'landing') {

			}
		}
	};

	var sc, ct, rdr, cmr;
	var fps;
	
    f.img.dom = new Image();
    f.img.dom.onload = init;    
    f.img.dom.src = f.img.src;
    
	function initScene() {
		var mh, ge, ma;
		mh = new THREE.Mesh();
		
		ge = new THREE.Geometry();
		var mat_Default = null;
		var verticesrc = [[786,960,0],[199,960,0],[-530,960,0],[613,545,-256],[330,590,-306],[676,260,-176],[497,236,-351],[526,236,-351],[617,261,-326],[576,294,-341],[138,410,-286],[424,291,-361],[365,260,-346],[480,75,-385],[471,-13,-384],[471,-16,-384],[557,-13,-384],[557,-10,-384],[533,18,-385],[595,-20,-345],[632,20,-461],[619,26,-355],[576,216,-341],[434,214,-361],[82,55,-271],[786,-82,0],[649,-170,-273],[512,-216,-356],[370,-50,-350],[419,-226,-356],[107,-235,-310],[-530,-174,0],[415,-335,-258],[786,-1010,0],[-530,-1015,0]];
		var polysrc = [[4,2,1],[23,10,9],[23,8,10],[22,8,23],[21,8,22],[20,19,22],[20,18,19],[28,17,20],[30,17,28],[30,16,17],[30,29,16],[15,19,18],[29,19,15],[29,14,19],[30,31,29],[29,25,14],[14,25,24],[14,24,7],[24,13,12],[25,13,24],[35,32,31],[31,25,29],[34,27,26],[26,6,1],[32,3,25],[13,11,12],[24,12,7],[33,30,28],[33,31,30],[21,14,7],[21,7,8],[19,14,21],[19,21,22],[6,9,4],[9,10,4],[10,5,4],[12,11,5],[31,32,25],[33,28,27],[12,5,10],[27,22,6],[22,23,9],[22,9,6],[8,12,10],[7,12,8],[11,3,2],[11,2,5],[4,5,2],[28,20,27],[27,20,22],[35,31,33],[34,33,27],[6,4,1],[27,6,26],[25,11,13],[25,3,11],[35,33,34]];
		var uvsrc = [[0.6711,0.8456],[0.4627,1],[1,1],[0.5022,0.6733],[0.5022,0.7122],[0.5623,0.6928],[0.5022,0.6733],[0.4309,0.6869],[0.5022,0.7122],[0.4637,0.5875],[0.4309,0.6869],[0.5022,0.6733],[0.4637,0.5875],[0.3745,0.595],[0.4309,0.6869],[0.4711,0.5479],[0.3802,0.57],[0.4637,0.5875],[0.4144,0.5479],[0.3802,0.57],[0.4711,0.5479],[0.446,0.4766],[0.4166,0.5374],[0.4711,0.5479],[0.3716,0.4766],[0.4166,0.5374],[0.446,0.4766],[0.3716,0.4766],[0.3723,0.5374],[0.4166,0.5374],[0.3716,0.4766],[0.3376,0.5484],[0.3723,0.5374],[0.4144,0.5479],[0.3703,0.5499],[0.3802,0.57],[0.3703,0.5499],[0.3376,0.5484],[0.3802,0.57],[0.3376,0.5484],[0.3194,0.585],[0.3802,0.57],[0.3716,0.4766],[0.2717,0.5089],[0.3376,0.5484],[0.3376,0.5484],[0.1689,0.6608],[0.3194,0.585],[0.3194,0.585],[0.1689,0.6608],[0.3097,0.6681],[0.3194,0.585],[0.3097,0.6681],[0.3755,0.6862],[0.3097,0.6681],[0.2512,0.6893],[0.3155,0.7061],[0.1689,0.6608],[0.2512,0.6893],[0.3097,0.6681],[0,0],[0,0.4258],[0.2717,0.5089],[0.2717,0.5089],[0.1689,0.6608],[0.3376,0.5484],[1,0],[0.6378,0.4835],[1,0.4726],[1,0.4726],[0.7418,0.7013],[1,1],[0,0.4258],[0,1],[0.1689,0.6608],[0.2512,0.6893],[0.2648,0.8329],[0.3155,0.7061],[0.3097,0.6681],[0.3155,0.7061],[0.3755,0.6862],[0.3992,0.4177],[0.3716,0.4766],[0.446,0.4766],[0.3992,0.4177],[0.2717,0.5089],[0.3716,0.4766],[0.3194,0.585],[0.3755,0.6862],[0.3745,0.595],[0.3745,0.595],[0.3755,0.6862],[0.4309,0.6869],[0.3802,0.57],[0.3194,0.585],[0.3745,0.595],[0.3802,0.57],[0.3745,0.595],[0.4637,0.5875],[0.5623,0.6928],[0.6711,0.8456],[0.7418,0.7013],[0.5623,0.6928],[0.5022,0.7122],[0.6711,0.8456],[0.5022,0.7122],[0.3916,0.8709],[0.6711,0.8456],[0.3155,0.7061],[0.2648,0.8329],[0.3916,0.8709],[0,0.4258],[0.1689,0.6608],[0.2717,0.5089],[0.3992,0.4177],[0.446,0.4766],[0.6378,0.4835],[0.3155,0.7061],[0.3916,0.8709],[0.5022,0.7122],[0.6378,0.4835],[0.4637,0.5875],[0.7418,0.7013],[0.4637,0.5875],[0.5022,0.6733],[0.5623,0.6928],[0.4637,0.5875],[0.5623,0.6928],[0.7418,0.7013],[0.4309,0.6869],[0.3155,0.7061],[0.5022,0.7122],[0.3755,0.6862],[0.3155,0.7061],[0.4309,0.6869],[0.2648,0.8329],[0,1],[0.4627,1],[0.2648,0.8329],[0.4627,1],[0.3916,0.8709],[0.6711,0.8456],[0.3916,0.8709],[0.4627,1],[0.446,0.4766],[0.4711,0.5479],[0.6378,0.4835],[0.6378,0.4835],[0.4711,0.5479],[0.4637,0.5875],[0,0],[0.3992,0.4177],[1,0],[0,0],[0.2717,0.5089],[0.3992,0.4177],[1,0],[0.3992,0.4177],[0.6378,0.4835],[0.7418,0.7013],[0.6711,0.8456],[1,1],[1,0.4726],[0.6378,0.4835],[0.7418,0.7013],[0.1689,0.6608],[0.2648,0.8329],[0.2512,0.6893],[0.1689,0.6608],[0,1],[0.2648,0.8329]];
		var matsrc = [{material:mat_Default,vIDs:[1,2,3]},{material:mat_Default,vIDs:[4,5,6]},{material:mat_Default,vIDs:[7,8,9]},{material:mat_Default,vIDs:[10,11,12]},{material:mat_Default,vIDs:[13,14,15]},{material:mat_Default,vIDs:[16,17,18]},{material:mat_Default,vIDs:[19,20,21]},{material:mat_Default,vIDs:[22,23,24]},{material:mat_Default,vIDs:[25,26,27]},{material:mat_Default,vIDs:[28,29,30]},{material:mat_Default,vIDs:[31,32,33]},{material:mat_Default,vIDs:[34,35,36]},{material:mat_Default,vIDs:[37,38,39]},{material:mat_Default,vIDs:[40,41,42]},{material:mat_Default,vIDs:[43,44,45]},{material:mat_Default,vIDs:[46,47,48]},{material:mat_Default,vIDs:[49,50,51]},{material:mat_Default,vIDs:[52,53,54]},{material:mat_Default,vIDs:[55,56,57]},{material:mat_Default,vIDs:[58,59,60]},{material:mat_Default,vIDs:[61,62,63]},{material:mat_Default,vIDs:[64,65,66]},{material:mat_Default,vIDs:[67,68,69]},{material:mat_Default,vIDs:[70,71,72]},{material:mat_Default,vIDs:[73,74,75]},{material:mat_Default,vIDs:[76,77,78]},{material:mat_Default,vIDs:[79,80,81]},{material:mat_Default,vIDs:[82,83,84]},{material:mat_Default,vIDs:[85,86,87]},{material:mat_Default,vIDs:[88,89,90]},{material:mat_Default,vIDs:[91,92,93]},{material:mat_Default,vIDs:[94,95,96]},{material:mat_Default,vIDs:[97,98,99]},{material:mat_Default,vIDs:[100,101,102]},{material:mat_Default,vIDs:[103,104,105]},{material:mat_Default,vIDs:[106,107,108]},{material:mat_Default,vIDs:[109,110,111]},{material:mat_Default,vIDs:[112,113,114]},{material:mat_Default,vIDs:[115,116,117]},{material:mat_Default,vIDs:[118,119,120]},{material:mat_Default,vIDs:[121,122,123]},{material:mat_Default,vIDs:[124,125,126]},{material:mat_Default,vIDs:[127,128,129]},{material:mat_Default,vIDs:[130,131,132]},{material:mat_Default,vIDs:[133,134,135]},{material:mat_Default,vIDs:[136,137,138]},{material:mat_Default,vIDs:[139,140,141]},{material:mat_Default,vIDs:[142,143,144]},{material:mat_Default,vIDs:[145,146,147]},{material:mat_Default,vIDs:[148,149,150]},{material:mat_Default,vIDs:[151,152,153]},{material:mat_Default,vIDs:[154,155,156]},{material:mat_Default,vIDs:[157,158,159]},{material:mat_Default,vIDs:[160,161,162]},{material:mat_Default,vIDs:[163,164,165]},{material:mat_Default,vIDs:[166,167,168]},{material:mat_Default,vIDs:[169,170,171]}];
		console.log('verticesrc.len='+verticesrc.length);
		console.log('uvsrc.len='+uvsrc.length);
		console.log('matsrc.len='+matsrc.length);
		console.log('polysrc.len='+polysrc.length);
		
		for (var i = 0; i < uvsrc.length; ++i ) {
			if ( uvsrc[i][0] == 0.3703 || uvsrc[i][0] == 0.4144 ) { uvsrc[i][1] -= 0.007; }
			else if ( uvsrc[i][0] == 0.3723 || uvsrc[i][0] == 0.4166 ) { uvsrc[i][1] += 0.002; }
		}
		for ( var i = 0; i < verticesrc.length; ++i ) { verticesrc[i][0] -= 130; }
		
		//*/
		var lb = new THREE.Vector3();
		var ub = new THREE.Vector3();
		for(i = 0, len = verticesrc.length ; i < len ; i++) {
			vt = new THREE.Vector3(verticesrc[i][0], verticesrc[i][1], verticesrc[i][2]);
			if(lb.x>vt.x)lb.x=vt.x;
			if(lb.y>vt.y)lb.y=vt.y;
			if(lb.z>vt.z)lb.z=vt.z;
			if(ub.x<vt.x)ub.x=vt.x;
			if(ub.y<vt.y)ub.y=vt.y;
			if(ub.z<vt.z)ub.z=vt.z;
			ge.vertices.push(vt);
		}
		
		for(i = 0, len = polysrc.length ; i < len  ; i++) {
			ge.faces.push(new THREE.Face3(polysrc[i][0]-1, polysrc[i][1]-1, polysrc[i][2]-1));
			ge.faceVertexUvs[0].push([
			new THREE.Vector2(uvsrc[matsrc[i].vIDs[0]-1][0], uvsrc[matsrc[i].vIDs[0]-1][1]), 
			new THREE.Vector2(uvsrc[matsrc[i].vIDs[1]-1][0], uvsrc[matsrc[i].vIDs[1]-1][1]), 
			new THREE.Vector2(uvsrc[matsrc[i].vIDs[2]-1][0], uvsrc[matsrc[i].vIDs[2]-1][1])
			]);
				
		}
		//*/
		//calFVUVs(ge);
		ge.computeBoundingSphere();
		mh.geometry = ge;
		
		//ma = new THREE.MeshBasicMaterial({wireframe:true, color:0xff0000});
		ma = new THREE.MeshBasicMaterial({map:f.img.tex});
		mh.material = ma;
		
		
		sc.add(mh);
	}
	
    function init() {
		f.img.b.w = f.img.dom.width;
		f.img.b.h = f.img.dom.height;
        f.img.tex = THREE.ImageUtils.loadTexture(f.img.src);
        //cmr = new THREE.OrthographicCamera(-f.img.b.w / 2, +f.img.b.w / 2, +f.img.b.h / 2, -f.img.b.h / 2, -256 / 2, +256 / 2);
		cmr = new THREE.OrthographicCamera(-1200, +1200, +1200, -1200, -1000, +1000);
        
        sc = new THREE.Scene();
		
		initScene();

        ct = document.createElement('div');
        document.body.appendChild(ct);

        //rdr = new Renderer2d();
        rdr = new THREE.CanvasRenderer();
		//rdr = new THREE.CSS3DRenderer();
		rdr.sortObjects = false;
        rdr.sortElements = false;
        rdr.setSize(512, 512);
        ct.appendChild(rdr.domElement);
		
        fps = new Stats();
        fps.setMode(0); // 0: fps, 1: ms
        fps.domElement.style.position = 'absolute';
        fps.domElement.style.left = '0px';
        fps.domElement.style.top = '0px';
        
        $('#fps_stats')[0].appendChild( fps.domElement );
        
		$('canvas').mousedown(onMouseDown);
		$('canvas').mouseup(onMouseUp);
		$('canvas').mousemove(onMouseMove);
		
		
		
		animate();
    }
    
    function animate() {
        requestAnimationFrame(animate);
		update();
		render();
        fps.update();
    }
	
	var cmrangle = {c:-Math.PI, t:-Math.PI, k:0.08};
	var ctime = 0;
	var ltime = 0;
	var el = 0;
	
	function update() {
		if(ltime == 0) el = 0;
		else { ctime = new Date().time; el = ctime - ltime; }
		ltime = ctime;
	
		cmrangle.c = cmrangle.c + (cmrangle.t - cmrangle.c) * cmrangle.k;
		cmr.position.x = Math.cos( cmrangle.c ) * 200;
		cmr.position.z = Math.sin( cmrangle.c ) * 200;
		cmr.lookAt( sc.position );
	}
	function render() {
        rdr.render(sc, cmr);
	}
	
	var currm = new THREE.Vector3();
	var lastm = new THREE.Vector3();
	
    var cvs;
    var cvsw;
    var cvsh;
    var ftw;
    var fth;
    var j2tp = new THREE.Vector3();
    function j2t(jx, jy) {
        if(cvs == null) {
            cvs = $('canvas');
            cvsw = cvs.width();
            cvsh = cvs.height();
            ftw = 2400;
            fth = 2400;                
        }
        j2tp.x = (jx - cvs[0].offsetLeft - cvsw/2) * ftw / cvsw;
        j2tp.y = -(jy - cvs[0].offsetTop - cvsh/2) * fth / cvsh;
        return j2tp;
    }
	
	var md = 0;
	function onMouseDown(evt) {
        j2t(event.pageX, event.pageY);
        lastm.copy(currm);
		currm.copy(j2tp);
		
		md = 1;
	}
	
	function onMouseUp(evt) {
        j2t(event.pageX, event.pageY);
        lastm.copy(currm);
		currm.copy(j2tp);
		
		md = 0;
	}
	
	function onMouseMove(evt) {
        j2t(event.pageX, event.pageY);
        lastm.copy(currm);
		currm.copy(j2tp);
		
		if(md) {
			cmrangle.t += (currm.x - lastm.x) / 400;
		}
	}
	

	
</script>
