<!DOCTYPE html>
<html>
    <link href='http://reset5.googlecode.com/hg/reset.min.css' rel='stylesheet' type='text/css'>

    <script src="js/jquery-2.0.0.min.js"></script>
    <script src="js/jquery.json-2.4.js"></script>
    <script src="js/sprintf-0.7-beta1.js"></script>
    <script src="js/threejs/build/three.js"></script>
    <script src="js/threejsex.js"></script>
    <script src="js/CanvasRenderer.js"></script>
    <script src="js/MeshBasicMaterial.js"></script>
    <script src="js/Stats.js"></script>
    <script src="js/sprintf.min.js"></script>

    
	<style>
		* {
			font-family: 'Open Sans', sans-serif;
			font-size: 15px;
			line-height:17px;
			
		}
		
		body {
			margin: 10px;
            background-color: #222222;
		}
	
		.dialog {
            background-color:rgba(251, 251, 251, 0.5);
            position:relative;
            min-height:47px;
			padding:4px 2px 2px 6px;
			
			border:1px solid #cccccc;
			margin:5px;
			
			-moz-user-select: none; 
			-khtml-user-select: none; 
			-webkit-user-select: none; 
			-o-user-select: none; 
            display:none;
		}
		#dlg2 {
			display:block;
		}
        
        #log {
            min-height:0px;
			-moz-user-select: none; 
			-khtml-user-select: none; 
			-webkit-user-select: none; 
			-o-user-select: none; 
        }
		
		#btnnext {
            position:absolute;
            bottom:5px;
            right:5px;
			float:right;
			width:100px;
			height:30px;
			
		}
		
		.ct {
			margin:5px; 
			display:inline-block;
			width:512px;
			height:512px;
			border:1px solid #cccccc;
		}
        
        #fps_stats {
            position:absolute;
            top:5px;
            right:85px;
        }
        
        
		
		.clear {
			clear:both;
		}
		

} 
    </style>
    
	
	
    <body id=body></body>
	
	<div class=dialog id=dlg1>
	<div id=instruction></div>
	<input type=button id=btnnext value=Next>	
	<div class=clear></div>
	</div>
    
    <div class=dialog id=dlg2>
        <div id=log></div>
    </div>
</html>
    
<script>
	var f = {
		img: {
			src:'images/monalisa.jpg',
			dom:null,
			b:{x:0, y:0, w:225, h:225}
		}
	
	};
	
	var sc, ct, rdr, cmr;
    var mh, ge, ma;
	var fps;
	
    f.img.dom = new Image();
    f.img.dom.onload = init;    
    f.img.dom.src = f.img.src;
    
    function init() {
        f.img.tex = THREE.ImageUtils.loadTexture(f.img.src);
        f.img.b.w = f.img.dom.width*2;
        f.img.b.h = f.img.dom.height*2;
        
        //cmr = new THREE.OrthographicCamera(-256, +256, +256, -256, -1256, +1256);
        cmr = new THREE.PerspectiveCamera( 70, 1, 1, 1000 );
        
        cmr.position.z = 512;
        
        sc = new THREE.Scene();
        ct = document.createElement('div');
		ct.id = 'cvsct';
		ct.className  = 'ct';
        document.body.appendChild(ct);

        rdr = new THREE.CanvasRenderer();
        //rdr.sortObjects = false;
        //rdr.sortElements = false;
        rdr.setSize(512, 512);
        rdr.domElement.id = 'mycanvas';
        ct.appendChild(rdr.domElement);
        
		
		
        fps = new Stats();
        fps.setMode(0); // 0: fps, 1: ms
        fps.domElement.style.position = 'absolute';
        fps.domElement.style.right = '2px';
        fps.domElement.style.bottom = '2px';
        $('#dlg2')[0].appendChild( fps.domElement );
		
		$('body').mousedown(onMouseDown);
		$('body').mouseup(onMouseUp);
		$('body').mousemove(onMouseMove);
        
        initScene();
        animate();
    }
    function initScene() {
        
        mh = new THREE.Mesh();
        mh.position.z = 100;
        mh.material = ma = new THREE.MeshBasicMaterial({map:new THREE.Texture(f.img.dom)});
        //mh.material =new THREE.MeshBasicMaterial({color:0xff5555});
        mh.geometry = ge = new THREE.Geometry();
        var i, j, k, mi = 11, mj = 11;
        ge.mi = mi; ge.mj = mj;
        var data;
        for(i = 0 ; i < mi ; i++) {
            for(j = 0 ; j < mj ; j++) {
                k = j + i * mj;
                vt = new THREE.Vector3(-f.img.b.w/2 + f.img.b.w/(mj-1)*j, -f.img.b.h/2 + f.img.b.h/(mi-1)*i, 0);
                vt.o = {};
                vt.o.x = vt.x;
                vt.o.y = vt.y;
                vt.o.z = vt.z;
                ge.vertices.push(vt);
                if(i > 0 && j > 0) {
                    var f31 = new THREE.Face3(k - mj - 1, k - mj, k);
                    var  f32 = new THREE.Face3(k, k - 1, k - mj - 1);
                    var v0 = ge.vertices[f31.a];
                    var v1 = ge.vertices[f31.b];
                    var v2 = ge.vertices[f31.c];
                    var v3 = ge.vertices[f32.b];
                    var uv0 = new THREE.Vector2(v0.x/f.img.b.w+0.5, v0.y/f.img.b.h+0.5);
                    var uv1 = new THREE.Vector2(v1.x/f.img.b.w+0.5, v1.y/f.img.b.h+0.5);
                    var uv2 = new THREE.Vector2(v2.x/f.img.b.w+0.5, v2.y/f.img.b.h+0.5);
                    var uv3 = new THREE.Vector2(v3.x/f.img.b.w+0.5, v3.y/f.img.b.h+0.5);

                    ge.faces.push(f31);
                    ge.faceVertexUvs[0].push([new THREE.Vector2().copy(uv0), new THREE.Vector2().copy(uv1), new THREE.Vector2().copy(uv2)]);
                    
                    ge.faces.push(f32);
                    ge.faceVertexUvs[0].push([new THREE.Vector2().copy(uv2), new THREE.Vector2().copy(uv3), new THREE.Vector2().copy(uv0)]);
                    
                }
            }
        }

        createTriangleTextureMesh(mh);
        ge.computeBoundingSphere();
        sc.add(mh);
        
    }

    function animate() {
        requestAnimationFrame(animate);
        update();
		render();
        fps.update();
    }

	function render() {
        rdr.render(sc, cmr);
	}
    
	var cmrangle = {c:Math.PI/2, t:Math.PI/2, k:0.08};
	var ctime = 0;
	var ltime = 0;
	var el = 0;
	
	function update() {
		if(ltime == 0){ ctime = new Date().getTime();  el = 0; }
		else { ctime = new Date().getTime(); el = ctime - ltime; }
		ltime = ctime;
	
        cmrangle.c = cmrangle.c + (cmrangle.t - cmrangle.c) * cmrangle.k;
		cmr.position.x = Math.cos( cmrangle.c ) * 512;
		cmr.position.z = Math.sin( cmrangle.c ) * 512;
		cmr.lookAt( sc.position );
      //*/  
        
        var i, j, k, mi = ge.mi, mj = ge.mj;
        for(i = 0 ; i < mi ; i++) {
            for(j = 0 ; j < mj ; j++) {
                k = j + i * mj;
                vt = ge.vertices[k];
                
                a = Math.PI * 2 / (mi - 1) * i;
                d = Math.sin(a + ctime / 500) * 20;
                
                vt.x = vt.o.x + d;
                vt.z = vt.o.z + d / 2;
            }
        }//*/
        //mh.rotation.z += el / -1500;
        
        var msg1 = ge ? sprintf('Animated Mesh with Triangle Texture in Canvas2D: vertices:%d, faces:%d', ge.vertices.length, ge.faces.length) : '';
        var msg2 = mov ? sprintf('(%.1f, %.1f)', currm.x, currm.y) : '';
        $('#log').html(msg1 + '<br>' + msg2);
	}
	function render() {
        rdr.render(sc, cmr);
	}
    
    function projectCvs2World2(vt, rdr, cmr) {
        vt.x = (vt.x / rdr.domElement.width - 0.5) * (cmr.right - cmr.left);
        vt.y = -(vt.y / rdr.domElement.height - 0.5) * (cmr.top - cmr.bottom);
        return vt;
    }
	
	var currm = new THREE.Vector3();
	var lastm = new THREE.Vector3();
    var pjvt = new THREE.Vector3();
	var md = 0;
    var mov = 0;
	function onMouseDown(evt) {
        
        projectCvs2World2(pjvt.set(evt.pageX - rdr.domElement.offsetLeft, evt.pageY - rdr.domElement.offsetTop), rdr, cmr);
        lastm.copy(currm);
		currm.copy(pjvt);
        
        if(inrng(evt.pageX-rdr.domElement.offsetLeft, 0, rdr.domElement.width) && inrng(evt.pageY-rdr.domElement.offsetTop, 0, rdr.domElement.height))
		  md = 1;
	}
	
	function onMouseUp(evt) {
        projectCvs2World2(pjvt.set(evt.pageX - rdr.domElement.offsetLeft, evt.pageY - rdr.domElement.offsetTop), rdr, cmr);
        lastm.copy(currm);
		currm.copy(pjvt);
		md = 0;
	}
	
	function onMouseMove(evt) {
        projectCvs2World2(pjvt.set(evt.pageX - rdr.domElement.offsetLeft, evt.pageY - rdr.domElement.offsetTop), rdr, cmr);
        lastm.copy(currm);
		currm.copy(pjvt);
		if(md) cmrangle.t += (currm.x - lastm.x) / -200;
        
        mov = inrng(evt.pageX-rdr.domElement.offsetLeft, 0, rdr.domElement.width) && inrng(evt.pageY-rdr.domElement.offsetTop, 0, rdr.domElement.height);
	}
	
</script>
