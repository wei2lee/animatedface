<!DOCTYPE html>
<html>
    <link href='http://reset5.googlecode.com/hg/reset.min.css' rel='stylesheet' type='text/css'>

    <script src="js/jquery-2.0.0.min.js"></script>
    <script src="js/jquery.json-2.4.js"></script>
    <script src="js/sprintf-0.7-beta1.js"></script>
    <script src="js/threejs/build/three.js"></script>
    <script src="js/threejsex.js"></script>
    <script src="js/Stats.js"></script>
    <script src="js/sprintf.min.js"></script>

    
	<style>
		* {
			font-family: 'Open Sans', sans-serif;
			font-size: 15px;
			line-height:17px;
			
		}
		
		body {
			margin: 10px;
            background-color: #222222;
		}
	
		.dialog {
            background-color:#fbfbfb;
            position:relative;
            min-height:150px;
			padding:4px 2px 2px 6px;
			width:460px;
			border:1px solid #cccccc;
			margin:5px 0 0 0;
			box-sizing: border-box;
			-moz-user-select: none; 
			-khtml-user-select: none; 
			-webkit-user-select: none; 
			-o-user-select: none; 
            display:none;
		}
		#dlg2 {
			display:block;
		}
        
        #log {
            min-height:0px;
			-moz-user-select: none; 
			-khtml-user-select: none; 
			-webkit-user-select: none; 
			-o-user-select: none; 
        }
		
		#btnnext {
            position:absolute;
            bottom:5px;
            right:5px;
			float:right;
			width:100px;
			height:30px;
			
		}
		
		.ct {
			margin:5px; 
			display:inline-block;
			width:512px;
			height:512px;
			border:1px solid #ff0000;
		}
        
        #fps_stats {
            position:absolute;
            top:5px;
            right:85px;
        }
        
        
		
		.clear {
			clear:both;
		}
		

} 
    </style>
    
	
	
    <body id=body></body>
	
	<div class=dialog id=dlg1>
	<div id=instruction></div>
	<input type=button id=btnnext value=Next>	
	<div class=clear></div>
	</div>
    
    <div class=dialog id=dlg2>
        <div id=log></div>
        <div id=fps_stats></div>
    </div>
</html>
    
<script>
	var f = {
		img: {
			src:'images/monalisa.jpg',
			dom:null,
			b:{x:0, y:0, w:225, h:225}
		}
	
	};
	
	var app = {
		st: null,
		setSt: function(st) {
			if(this.st == st) return;
			this.st = st;
			
			if(st == 'landing') {

			}
		}
	};
	var sc, ct, rdr, cmr;
	var nsmx4;
	var fps;
	
    f.img.dom = new Image();
    f.img.dom.onload = init;    
    f.img.dom.src = f.img.src;
    
    function init() {
        f.img.tex = THREE.ImageUtils.loadTexture(f.img.src);
        f.img.b.w = f.img.dom.width;
        f.img.b.h = f.img.dom.height;
        
        cmr = new THREE.OrthographicCamera(-256, +256, +256, -256, -1256, +1256);
        
        sc = new THREE.Scene();
        ct = document.createElement('div');
		ct.id = 'cvsct';
		ct.className  = 'ct';
        document.body.appendChild(ct);

        rdr = new THREE.CanvasRenderer();
		rdr.sortObjects = false;
        rdr.sortElements = false;
        rdr.setSize(512, 512);
        ct.appendChild(rdr.domElement);
        rdr.domElement.id = 'mycanvas';
		
		
        fps = new Stats();
        fps.setMode(0); // 0: fps, 1: ms
        fps.domElement.style.position = 'absolute';
        fps.domElement.style.left = '0px';
        fps.domElement.style.top = '0px';
        
        $('#fps_stats')[0].appendChild( fps.domElement );
		
		$('body').mousedown(onMouseDown);
		$('body').mouseup(onMouseUp);
		$('body').mousemove(onMouseMove);
        
		
        //init2d();        
        //initCSS();
        //testTriangle();
        testPretexture();

		
		var pj = new THREE.Projector();
		var pjvt = pj.projectVector(new THREE.Vector3(256,128,0), cmr);
        
        pjvt.x = (pjvt.x / 2 + 0.5) * rdr.domElement.width;
        pjvt.y = (pjvt.y / -2 + 0.5) * rdr.domElement.height;
		
        
		var upjvt = pj.unprojectVector(new THREE.Vector3(2, 0, 0), cmr);
		console.log(upjvt);
        animate();
    }
    function init2d() {
		var mh, ge, ma;

        mh = new THREE.Mesh();
        
        var i, j, k, mi = 10, mj = 10;
        ge = new THREE.Geometry();
        for(i = 0 ; i < mi ; i++) {
            for(j = 0 ; j < mj ; j++) {
                k = j + i * mj;
                vt = new THREE.Vector3(-f.img.b.w/2 + f.img.b.w/(mj-1)*j, -f.img.b.h/2 + f.img.b.h/(mi-1)*i, 0);
                ge.vertices.push(vt);
                if(i > 0 && j > 0) {
                    f4 = new THREE.Face4(k - mj - 1, k - mj, k, k - 1);
                    ge.faces.push(f4);
                }
            }
        }
        calFVUVs(ge);
        //ge = new THREE.PlaneGeometry(f.img.b.w, f.img.b.h);
        mh.geometry = ge;
        ge.computeBoundingSphere();
        

        
        ma = new THREE.MeshBasicMaterial({map:f.img.tex});
        //ma = new THREE.MeshBasicMaterial({wireframe:false, color:0xff0000});
        mh.material = ma;
        sc.add(mh);
    }


    function testPretexture() {
		var mh, ge, ma;


        mh = new THREE.Mesh();
        
        ma = new THREE.MeshFaceMaterial();
        ge = new THREE.Geometry();
        var i, j, k, mi = 2, mj = 2;
        var mai = 0;
        var data;
        for(i = 0 ; i < mi ; i++) {
            for(j = 0 ; j < mj ; j++) {
                k = j + i * mj;
                vt = new THREE.Vector3(-f.img.b.w/2 + f.img.b.w/(mj-1)*j, -f.img.b.h/2 + f.img.b.h/(mi-1)*i, 0);
                ge.vertices.push(vt);
                if(i > 0 && j > 0) {
                    f31 = new THREE.Face3(k - mj - 1, k - mj, k);
                    f32 = new THREE.Face3(k, k - 1, k - mj - 1);
                    var v0 = ge.vertices[f31.a];
                    var v1 = ge.vertices[f31.b];
                    var v2 = ge.vertices[f31.c];
                    var v3 = ge.vertices[f32.b];
                    var uv0 = new THREE.Vector2(ge.vertices[f31.a].x/f.img.b.w+0.5, ge.vertices[f31.a].y/f.img.b.h+0.5);
                    var uv1 = new THREE.Vector2(ge.vertices[f31.b].x/f.img.b.w+0.5, ge.vertices[f31.b].y/f.img.b.h+0.5);
                    var uv2 = new THREE.Vector2(ge.vertices[f31.c].x/f.img.b.w+0.5, ge.vertices[f31.c].y/f.img.b.h+0.5);
                    var uv3 = new THREE.Vector2(ge.vertices[f32.b].x/f.img.b.w+0.5, ge.vertices[f32.b].y/f.img.b.h+0.5);
                    data = createTriangleTextureData(v0, v1, v2, uv0, uv1, uv2, f.img.dom);
                    ma.materials.push(new THREE.MeshBasicMaterial({map:new THREE.Texture(data.imgdom)}));
                    
                    
                    f31.materialIndex = ma.materials.length - 1;
                    ge.faces.push(f31);
                    ge.faceVertexUvs[0].push([data.uv0, data.uv1, data.uv2]);
                    
                    //data = createTriangleTextureData(v2, v3, v0, uv2, uv3, uv0, f.img.dom);
                    //ma.materials.push(new THREE.MeshBasicMaterial({map:new THREE.Texture(data.imgdom)}));
                    //f32.materialIndex = ma.materials.length - 1;
                    //ge.faces.push(f32);
                    //ge.faceVertexUvs[0].push([data.uv0, data.uv1, data.uv2]);
                    
                }
            }
        }//*/
        //ge = new THREE.PlaneGeometry(200, 300);
        //ma = new THREE.MeshBasicMaterial({map:f.img.tex});
        ma = new THREE.MeshBasicMaterial({map:new THREE.Texture(data.imgdom)});
        
        //ma = new THREE.MeshBasicMaterial({color:0xff0000, wireframe:true});
        //calFVUVs(ge);
        mh.material = ma;
        mh.geometry = ge;
        ge.computeBoundingSphere();
        sc.add(mh);
        
    }


    var ctv0 = new THREE.Vector3();    
    var ctv1 = new THREE.Vector3();    
    var ctv2 = new THREE.Vector3();    
    
    var ctuv0 = new THREE.Vector2();
    var ctuv1 = new THREE.Vector2();
    var ctuv2 = new THREE.Vector2();
    
    var ctlb = new THREE.Vector2();
    var ctub = new THREE.Vector2();
    
    var pj = new THREE.Projector();
    function projectCanvas(vt) {
        pj.projectVector(vt, cmr);
        vt.x = (vt.x / 2 + 0.5) * rdr.domElement.width;
        vt.y = (vt.y / -2 + 0.5) * rdr.domElement.height;
        return vt;
    }
    
    function createTriangleTextureData(v0, v1, v2, uv0, uv1, uv2, tex) {
        
        
        ctv0.copy(v0);
        projectCanvas(ctv0);
        
        ctv1.copy(v1);
        projectCanvas(ctv1);
        
        ctv2.copy(v2);
        projectCanvas(ctv2);
        
        ctuv0.copy(uv0);
        ctuv0.y = 1 - ctuv0.y;
        
        ctuv1.copy(uv1);
        ctuv1.y = 1 - ctuv1.y;

        ctuv2.copy(uv2);
        ctuv2.y = 1 - ctuv2.y;
        
        var img = new Image();
        var cvs = document.createElement('canvas');
        var ctx = cvs.getContext('2d');
        
        ctlb.x = Math.min(ctv0.x, ctv1.x, ctv2.x);
        ctlb.y = Math.min(ctv0.y, ctv1.y, ctv2.y);
        ctub.x = Math.max(ctv0.x, ctv1.x, ctv2.x);
        ctub.y = Math.max(ctv0.y, ctv1.y, ctv2.y);

        cvs.width = ctub.x - ctlb.x;
        cvs.height = ctub.y - ctlb.y;
        ctx.clearRect(0, 0, cvs.width, cvs.height);
        
        ctv0.x -= ctlb.x;
        ctv0.y -= ctlb.y;
        ctv1.x -= ctlb.x;
        ctv1.y -= ctlb.y;
        ctv2.x -= ctlb.x;
        ctv2.y -= ctlb.y;        
        drawTriangle(ctv0.x, ctv0.y, ctv1.x, ctv1.y, ctv2.x, ctv2.y, ctx);
        clipImage(ctv0.x, ctv0.y, ctv1.x, ctv1.y, ctv2.x, ctv2.y, ctuv0.x, ctuv0.y, ctuv1.x, ctuv1.y, ctuv2.x, ctuv2.y, tex, ctx);
        img.src = cvs.toDataURL();
        
        $('body')[0].appendChild(img);
        
        ctuv0.set(ctv0.x / cvs.width, 1 - ctv0.y / cvs.height);
        ctuv1.set(ctv1.x / cvs.width, 1 - ctv1.y / cvs.height);
        ctuv2.set(ctv2.x / cvs.width, 1 - ctv2.y / cvs.height);
        
        
        return {imgdom:img, uv0:new THREE.Vector2().copy(ctuv0), uv1:new THREE.Vector2().copy(ctuv1), uv2:new THREE.Vector2().copy(ctuv2)};
    }
    

    function animate() {
        requestAnimationFrame(animate);
        //update();
		render();
        fps.update();
    }

	function render() {
        rdr.render(sc, cmr);
	}
    
	var cmrangle = {c:-Math.PI, t:-Math.PI, k:0.08};
	var ctime = 0;
	var ltime = 0;
	var el = 0;
	
	function update() {
		if(ltime == 0) el = 0;
		else { ctime = new Date().time; el = ctime - ltime; }
		ltime = ctime;
	
        cmrangle.c = cmrangle.c + (cmrangle.t - cmrangle.c) * cmrangle.k;
		cmr.position.x = Math.cos( cmrangle.c ) * 512;
		cmr.position.z = Math.sin( cmrangle.c ) * 512;
		cmr.lookAt( sc.position );
	}
	function render() {
        rdr.render(sc, cmr);
	}
	
	var currm = new THREE.Vector3();
	var lastm = new THREE.Vector3();
	
    var cvs;
    var ftw;
    var fth;
    var j2tp = new THREE.Vector3();
    function j2t(jx, jy) {
        if(cvs == null) {
            cvs = $('#mycanvas');
            cvsw = rdr.domElement.width;
            cvsh = rdr.domElement.height;  
            ftw = cmr.right - cmr.left;
            fth = cmr.top - cmr.bottom;                
        }
        j2tp.x = (jx - cvs[0].offsetLeft - cvsw/2) * ftw / cvsw;
        j2tp.y = -(jy - cvs[0].offsetTop - cvsh/2) * fth / cvsh;
        return j2tp;
    }
	
	var md = 0;
	function onMouseDown(evt) {
        j2t(event.pageX, event.pageY);
        lastm.copy(currm);
		currm.copy(j2tp);
		
		md = 1;
	}
	
	function onMouseUp(evt) {
        j2t(event.pageX, event.pageY);
        lastm.copy(currm);
		currm.copy(j2tp);
		
		md = 0;
	}
	
	function onMouseMove(evt) {
        j2t(event.pageX, event.pageY);
        lastm.copy(currm);
		currm.copy(j2tp);
		if(md) {
			cmrangle.t += (currm.x - lastm.x) / 200;
		}
	}
	
</script>
