<!DOCTYPE html>
<html>
    <script src="http://code.jquery.com/jquery-1.9.1.min.js"></script>
    <script src="http://cdnjs.cloudflare.com/ajax/libs/gsap/latest/TweenMax.min.js"></script>
    <script src="js/jquery.json-2.4.js"></script>
    <script src="js/sprintf-0.7-beta1.js"></script>
    <script src="js/three.js-master/build/three.js"></script>
    <script src="js/Stats.js"></script>
    <script src="js/sprintf.min.js"></script>
    <link href='http://fonts.googleapis.com/css?family=Noto+Serif' rel='stylesheet' type='text/css'>
    <link href='http://reset5.googlecode.com/hg/reset.min.css' rel='stylesheet' type='text/css'>
	
	<style>
		* {
			font-family: 'Noto Serif', serif;
			
		}
		
		body {
			margin: 10px;
		}
	
        canvas {
            border:1px solid #cccccc;
            margin:5px 0 0 0;
            cursor: pointer;
        }
		
		
		.dialog {
            position:relative;
            min-height:150px;
			padding:4px 2px 2px 6px;
			width:460px;
			border:1px solid #cccccc;
			margin:5px 0 0 0;
			box-sizing: border-box;
		}
        
        #log {
            min-height:0px;
        }
		
		#btnnext {
            position:absolute;
            bottom:5px;
            right:5px;
			float:right;
			width:100px;
			height:30px;
			
		}
		
		.clear {
			clear:both;
		}
    </style>
    
	
	
    <body id=body></body>
	
	<div class=dialog>
	<div id=instruction></div>
	<input type=button id=btnnext value=Next>	
	<div class=clear></div>
	</div>
    
    <div class=dialog id=log>
    LOG
    </div>

    
    
    <script>
        function clamp(val,min,max) { return val<min?min:(val>max?max:val); };
        function inrange(val,lb,up) { return lb  <= val && val <= up; }
        function glsurange(val,lb,up) { return lb  <= val && val < up; }
        
        THREE.Face3.prototype.set = function(a,b,c) {
            this.a=a;
            this.b=b;
            this.c=c;
        };
        
        THREE.Face4.prototype.set = function(a,b,c,d) {
            this.a=a;
            this.b=b;
            this.c=c;
            this.d=d;
        };
        
		var st;
        var debug = 1;
        var bms = [];
        var f = {
            ey: {
                b: {
                    x: 0,
                    y: 0,
                    w: 0,
                    h: 0
                },
                
                
                mesh: null,
                dbmesh: null,
                
                
                lx:[-33,  -9, +18,  +46],   
                ly:[+6, +17],
                    
                    
                lxi:[0,0,0,0],
                lyi:[0,0]
                               
            },
            le: {
                b: {
                    x: 0,
                    y: 0,
                    w: 0,
                    h: 0
                },
                mesh: null,
                dbmesh: null
            },
            re: {
                b: {
                    x: 0,
                    y: 0,
                    w: 0,
                    h: 0
                },
                mesh: null,
                dbmesh: null
                
                
            },
            no: {
                b: {
                    x: 0,
                    y: 0,
                    w: 0,
                    h: 0
                },
                
                lx:[],
                ly:[-28],
                    
                lxi:[],
                lyi:[0]
                   
                
            },
            mo: {
                b: {
                    x: 0,
                    y: 0,
                    w: 0,
                    h: 0
                },
                mesh: null,
                dbmesh: null,
                
                lx:[-18,  +29],   
                ly:[-58, -38],
                    
                lxi:[0,0],
                lyi:[0,0]
                   
                
                
            },
            fc: {
                b: {
                    x: 0,
                    y: 0,
                    w: 256,
                    h: 256,
                },
                mesh: null,
                dbmesh: null,
				mat_dbmh: null,
				mat_mh: null,
                fci: {v:0, f:0},
                moi: {v:0, f:0},
                lei: {v:0, f:0},
                rei: {v:0, f:0},
                
                
				xgl: null,
				ygl: null,
				bgmesh: null,
				lmato: null,
				lmat_ey: null,
				lmat_mo: null,
				lmat_no: null,
				
				tlx:null,
                tly:null,
                
                lx:[-51, +57],   
                ly:[-90, +78],
                    
                lxi:[0,0],
                lyi:[0,0],
                
                updateGrid:function() {
                    var geo;
					var mh;
					var init;
					var lx;
					var ly;
                    if(f.fc.xgl == null) {
						f.fc.lmato = new THREE.LineBasicMaterial({
							color: 0x0000ff
						});
						f.fc.lmat_ey = new THREE.LineBasicMaterial({
							color: 0xff0000
						});
						f.fc.lmat_mo = new THREE.LineBasicMaterial({
							color: 0x00ff00
						});
						f.fc.lmat_no = new THREE.LineBasicMaterial({
							color: 0x000000
						});
					
						f.fc.bgmesh = new THREE.Mesh(new THREE.PlaneGeometry(f.fc.b.w, f.fc.b.h));
						f.fc.bgmesh.material = new THREE.MeshBasicMaterial({
							map: f.img.tex,
							overdraw: true
						});
					
						f.fc.xgl = [];
						f.fc.ygl = [];
						init = 1;
						
                        lx = f.fc.tlx = [f.fc.lx[0], f.ey.lx[0], f.mo.lx[0],  f.ey.lx[1], f.ey.lx[2], f.mo.lx[1], f.ey.lx[3],  f.fc.lx[1]];
                        f.fc.lxi = [0, 7];
                        f.ey.lxi = [1, 3, 4, 6];
                        f.mo.lxi = [2, 5];
                        
						ly = f.fc.tly = [f.fc.ly[0], f.mo.ly[0], f.mo.ly[1], f.no.ly[0],  f.ey.ly[0], f.ey.ly[1],  f.fc.ly[1]];    
					    f.fc.lyi = [0, 6];
                        f.mo.lyi = [1, 2];
                        f.no.lyi = [3];
                        f.ey.lyi = [4, 5];
					
					}else{
                        lx = f.fc.tlx;
						ly = f.fc.tly;
						init = 0;
                    }
					
					
					var fi = 0;
                    var vi = 0;
					

					var lgeo;
					var lmh;
					
                    for(i = 0 ; i < ly.length ; i++) {
						if(init) {
							lmh = new THREE.Line();
							lgeo = new THREE.Geometry();
							lgeo.vertices.push(new THREE.Vector3(lx[0], ly[i], 1));
							lgeo.vertices.push(new THREE.Vector3(lx[lx.length-1], ly[i], 1));
							
							lmh.geometry = lgeo;
							
							if(ly[i] == f.mo.ly[0] || ly[i] == f.mo.ly[1]) lmh.material = f.fc.lmat_mo;
							else if(ly[i] == f.ey.ly[0] || ly[i] == f.ey.ly[1]) lmh.material = f.fc.lmat_ey;
							else if(ly[i] == f.no.ly[0]) lmh.material = f.fc.lmat_no;
							else lmh.material = f.fc.lmato;
                            //*/
                            /*
                            if(f.mo.l.yi.indexOf(i) >= 0) lmh.material = f.fc.lmat_mo;
                            else if(f.ey.l.yi.indexOf(i) >= 0) lmh.material = f.fc.lmat_ey;
                            else if(f.no.l.yi.indexOf(i) >= 0) lmh.material = f.fc.lmat_no;
                            else lmh.material = f.fc.lmato;
                            //*/
							lmh.userData.i = i;
							lmh.userData.ax = 'y';
							
							f.fc.ygl.push(lmh);
							
							
						} else {
							lmh = f.fc.ygl[i];
							lgeo = lmh.geometry;
							lgeo.vertices[0].set(lx[0], ly[i], 1);
							lgeo.vertices[1].set(lx[lx.length-1], ly[i], 1);
						}
                    }
					
                    for(i = 0 ; i < lx.length ; i++) {
						if(init) {
							lmh = new THREE.Line();
							lgeo = new THREE.Geometry();
							lgeo.vertices.push(new THREE.Vector3(lx[i], ly[0], 1));
							lgeo.vertices.push(new THREE.Vector3(lx[i], ly[ly.length-1], 1));
							
							lmh.geometry = lgeo;
							
                            if(lx[i] == f.mo.lx[0] || lx[i] == f.mo.lx[1]) lmh.material = f.fc.lmat_mo;
							else if(lx[i] == f.ey.lx[0] || lx[i] == f.ey.lx[1] || lx[i] == f.ey.lx[2] || lx[i] == f.ey.lx[3]) lmh.material = f.fc.lmat_ey;
							else lmh.material = f.fc.lmato;
							//*/
                            /*
                            if(f.mo.l.xi.indexOf(i) >= 0) lmh.material = f.fc.lmat_mo;
                            else if(f.ey.l.xi.indexOf(i) >= 0) lmh.material = f.fc.lmat_ey;
                            else lmh.material = f.fc.lmato;
                            //*/
                            lmh.userData.i = i;
							lmh.userData.ax = 'x';
							
							f.fc.xgl.push(lmh);
						} else {
							lmh = f.fc.xgl[i];
							lgeo = lmh.geometry;
							lgeo.vertices[0].set(lx[i], ly[0], 1);
							lgeo.vertices[1].set(lx[i], ly[ly.length-1], 1);
						}
                    }
				},
                
                updateGridData: function() {
                    for(i = 0 ; i <  f.fc.lxi.length ; i++)
                        f.fc.lx[i] = f.fc.tlx[f.fc.lxi[i]];
                    for(i = 0 ; i <  f.ey.lyi.length ; i++)
                        f.fc.ly[i] = f.fc.tly[f.fc.lyi[i]];
                    
                    f.fc.b.x = (f.fc.lx[0] + f.fc.lx[1])/2;
                    f.fc.b.y = (f.fc.ly[0] + f.fc.ly[1])/2;
                    f.fc.b.w = (f.fc.lx[1] - f.fc.lx[0]);
                    f.fc.b.h = (f.fc.ly[1] - f.fc.ly[0]);
                    
                    for(i = 0 ; i <  f.ey.lxi.length ; i++)
                        f.ey.lx[i] = f.fc.tlx[f.ey.lxi[i]];
                    for(i = 0 ; i <  f.ey.lyi.length ; i++)
                        f.ey.ly[i] = f.fc.tly[f.ey.lyi[i]];
                    
                    f.le.b.x = (f.ey.lx[2] + f.ey.lx[3])/2;
                    f.le.b.y = (f.ey.ly[0] + f.ey.ly[1])/2;
                    f.le.b.w = (f.ey.lx[3] - f.ey.lx[2]);
                    f.le.b.h = (f.ey.ly[1] - f.ey.ly[0]);
                    
                    f.re.b.x = (f.ey.lx[0] + f.ey.lx[1])/2;
                    f.re.b.y = (f.ey.ly[0] + f.ey.ly[1])/2;
                    f.re.b.w = (f.ey.lx[1] - f.ey.lx[0]);
                    f.re.b.h = (f.ey.ly[1] - f.ey.ly[0]);
                    
                    
                    for(i = 0 ; i <  f.mo.lxi.length ; i++)
                        f.mo.lx[i] = f.fc.tlx[f.mo.lxi[i]];
                    for(i = 0 ; i <  f.mo.lyi.length ; i++)
                        f.mo.ly[i] = f.fc.tly[f.mo.lyi[i]];

                    f.mo.b.x = (f.mo.lx[0] + f.mo.lx[1])/2;
                    f.mo.b.y = (f.mo.ly[0] + f.mo.ly[1])/2;
                    f.mo.b.w = (f.mo.lx[1] - f.mo.lx[0]);
                    f.mo.b.h = (f.mo.ly[1] - f.mo.ly[0]);
                    
                    
                },

                updateMesh:function() {
                    var geo;
                    
                    
                    var fci = f.fc.fci;
                    var moi = f.fc.moi;
                    var lei = f.fc.lei;
                    var rei = f.fc.rei;
                    var lx = f.fc.tlx;
					var ly = f.fc.tly;
                    
                    var init = 0;
                    
                    if(f.fc.mesh == null) {
						f.fc.mat_dbmh = new THREE.MeshBasicMaterial({
							color: 0xff5555,
							wireframe: true,
						});
						
						f.fc.mat_mh = new THREE.MeshBasicMaterial({
							map: f.img.tex,
							overdraw: true
						});
                        
					
                        f.fc.mesh = new THREE.Mesh();
                        f.fc.mesh.geometry = geo = new THREE.Geometry();
						f.fc.mesh.material = f.fc.mat_mh;
						
                        fci.v = 0;
                        fci.f = 0;
                        for(i = 0 ; i < lx.length*ly.length ; i++) { geo.vertices.push(new THREE.Vector3()); }
                        for(i = 0 ; i < 100 ; i++) { geo.faces.push(new THREE.Face4(0,0,0,0)); }
                        
                        rei.v = geo.vertices.length;
                        rei.f = geo.faces.length;
                        for(i = 0 ; i < 8 ; i++) { geo.vertices.push(new THREE.Vector3()); }
                        for(i = 0 ; i < 8 ; i++) { geo.faces.push(new THREE.Face3(0,0,0)); }
                        for(i = 0 ; i < 1 ; i++) { geo.faces.push(new THREE.Face4(0,0,0,0)); }
                        

                        lei.v = geo.vertices.length;
                        lei.f = geo.faces.length;
                        for(i = 0 ; i < 8 ; i++) { geo.vertices.push(new THREE.Vector3()); }
                        for(i = 0 ; i < 8 ; i++) { geo.faces.push(new THREE.Face3(0,0,0)); }
                        for(i = 0 ; i < 1 ; i++) { geo.faces.push(new THREE.Face4(0,0,0,0)); }
                        
                        moi.v = geo.vertices.length;
                        moi.f = geo.faces.length;
                        for(i = 0 ; i < 20 ; i++) { geo.vertices.push(new THREE.Vector3()); }
                        for(i = 0 ; i < 8 ; i++) { geo.faces.push(new THREE.Face4(0,0,0,0)); }
                    
                        
                        
                        f.fc.dbmesh = new THREE.Mesh();
                        f.fc.dbmesh.geometry = f.fc.mesh.geometry;
                        f.fc.dbmesh.material = f.fc.mat_dbmh;
                        
                        
                        init = 1;
                    }else{
                        geo = f.fc.mesh.geometry;   
                    }
                            
					/////////////////Face 
                    
					var kv = fci.v;
                    var kf = fci.f;
                    loop:
                    for(i = 0 ; i < ly.length ; i++) {
                        for(j = 0 ; j < lx.length ; j++) {
                            vi = j + i * lx.length;
                            geo.vertices[kv].set(lx[j], ly[i], 0);
                            
                            if(i > 0 && j > 0) {
                                if(glsurange(i, f.mo.lyi[0]+1, f.mo.lyi[1]+1) && glsurange(j, f.mo.lxi[0]+1, f.mo.lxi[1]+1)) {
                                } else if(glsurange(i, f.ey.lyi[0]+1, f.ey.lyi[1]+1) && glsurange(j, f.ey.lxi[0]+1, f.ey.lxi[1]+1)) {
                                } else if(glsurange(i, f.ey.lyi[0]+1, f.ey.lyi[1]+1) && glsurange(j, f.ey.lxi[2]+1, f.ey.lxi[3]+1)) {
                                } else {
                                    geo.faces[kf].a = kv - lx.length - 1;
                                    geo.faces[kf].b = kv - lx.length;
                                    geo.faces[kf].c = kv;
                                    geo.faces[kf].d = kv - 1;
                                    kf++;                                    
                                }
                            }
                            kv++;
                        }
                    }
                    //*/
                    
                    /////////////////Left Eye 
                    
                    kv = lei.v;
                    geo.vertices[kv++].set(f.le.b.x - f.le.b.w / 2, f.le.b.y - f.le.b.h / 2, 0);                
                    geo.vertices[kv++].set(f.le.b.x + f.le.b.w / 2, f.le.b.y - f.le.b.h / 2, 0);  
                    geo.vertices[kv++].set(f.le.b.x + f.le.b.w / 2, f.le.b.y + f.le.b.h / 2, 0);  
                    geo.vertices[kv++].set(f.le.b.x - f.le.b.w / 2, f.le.b.y + f.le.b.h / 2, 0);  
                    geo.vertices[kv++].set(f.le.b.x, f.le.b.y - f.le.b.h / 2 * 0.6, 0);  ;
                    geo.vertices[kv++].set(f.le.b.x + f.le.b.w / 2 * 0.8, f.le.b.y, 0);  
                    geo.vertices[kv++].set(f.le.b.x, f.le.b.y + f.le.b.h / 2 * 0.6, 0);  
                    geo.vertices[kv++].set(f.le.b.x - f.le.b.w / 2 * 0.8, f.le.b.y, 0);  
                    
                    kf  = lei.f;
                    geo.faces[kf++].set(lei.v + 0, lei.v + 4, lei.v + 7);
                    geo.faces[kf++].set(lei.v + 0, lei.v + 1, lei.v + 4);
                    geo.faces[kf++].set(lei.v + 4, lei.v + 1, lei.v + 5);
                    geo.faces[kf++].set(lei.v + 5, lei.v + 1, lei.v + 2);
                    geo.faces[kf++].set(lei.v + 6, lei.v + 5, lei.v + 2);
                    geo.faces[kf++].set(lei.v + 3, lei.v + 6, lei.v + 2);
                    geo.faces[kf++].set(lei.v + 3, lei.v + 7, lei.v + 6);
                    geo.faces[kf++].set(lei.v + 3, lei.v + 0, lei.v + 7);
                    geo.faces[kf++].set(lei.v + 4, lei.v + 5, lei.v + 6, lei.v + 7);
                    
                    
                    /////////////////Right Eye 
                    
                    kv = rei.v;
                    geo.vertices[kv++].set(f.re.b.x - f.re.b.w / 2, f.re.b.y - f.re.b.h / 2, 0);                
                    geo.vertices[kv++].set(f.re.b.x + f.re.b.w / 2, f.re.b.y - f.re.b.h / 2, 0);  
                    geo.vertices[kv++].set(f.re.b.x + f.re.b.w / 2, f.re.b.y + f.re.b.h / 2, 0);  
                    geo.vertices[kv++].set(f.re.b.x - f.re.b.w / 2, f.re.b.y + f.re.b.h / 2, 0);  
                    geo.vertices[kv++].set(f.re.b.x, f.re.b.y - f.le.b.h / 2 * 0.6, 0);  ;
                    geo.vertices[kv++].set(f.re.b.x + f.re.b.w / 2 * 0.8, f.re.b.y, 0);  
                    geo.vertices[kv++].set(f.re.b.x, f.re.b.y + f.re.b.h / 2 * 0.6, 0);  
                    geo.vertices[kv++].set(f.re.b.x - f.re.b.w / 2 * 0.8, f.re.b.y, 0);
                    
                    kf  = rei.f;
                    geo.faces[kf++].set(rei.v + 0, rei.v + 4, rei.v + 7);
                    geo.faces[kf++].set(rei.v + 0, rei.v + 1, rei.v + 4);
                    geo.faces[kf++].set(rei.v + 4, rei.v + 1, rei.v + 5);
                    geo.faces[kf++].set(rei.v + 5, rei.v + 1, rei.v + 2);
                    geo.faces[kf++].set(rei.v + 6, rei.v + 5, rei.v + 2);
                    geo.faces[kf++].set(rei.v + 3, rei.v + 6, rei.v + 2);
                    geo.faces[kf++].set(rei.v + 3, rei.v + 7, rei.v + 6);
                    geo.faces[kf++].set(rei.v + 3, rei.v + 0, rei.v + 7);
                    geo.faces[kf++].set(rei.v + 4, rei.v + 5, rei.v + 6, rei.v + 7);
                    
                    
                    
                    /////////////////Mouth
                    
                    kv = moi.v;
                    kf  = moi.f;
                    for(i = 0 ; i < 3 ; i++) {
                        for(j = 0 ; j < 5 ; j++) {
                            geo.vertices[kv].set(f.mo.b.x - f.mo.b.w/2 + f.mo.b.w*j/4, f.mo.b.y - f.mo.b.h/2 + f.mo.b.h*i/2, 0);
                            if(i > 0 && j > 0) {
                                geo.faces[kf++].set(kv - 6, kv - 5, kv, kv - 1);
                            }
                            kv++;
                        }
                    }
                    
                    
                    
                    
                    
                    
                    if(init) computeFaceVertexUvs(geo);

                }
            },
            b: {
                x: 0,
                y: 0,
                w: 256,
                h: 256
            },
            img: {
				tex: null,
                src: 'images/man.jpg',
                //src: 'images/sadgirl.jpg',
                b: {
                    x: 0,
                    y: 0,
                    w: 256,
                    h: 256
                }
            },
            fdr: {
                src: 'facedetect.man.json',
                //src: 'facedetect.sadgirl.jpg.json'
            }
        };
        
        var camera, scene, renderer;


        $(window).load(initBitmaps);

        function initBitmaps() {

            $('#srcimg').attr('src', f.img.src);


            var imgObj = new Image();
            bms.push(imgObj);
            imgObj.onload = initFaceDetection;
            imgObj.src = f.img.src;
        }

        function initFaceDetection() {
            initThreeJS();
        }

        function initThreeJS() {
            initScene();
            animate();
        }

        function computeFaceVertexUvs(geo) {
            
            if(geo.faceVertexUvs[0].length > 0) {
            
                for (i = 0; i < geo.faceVertexUvs[0].length; i++) {
                    for (j = 0; j < geo.faceVertexUvs[0][i].length; j++) {
                        uv = geo.faceVertexUvs[0][i][j];
                        uv.x = uv.x / f.b.w + 0.5;
                        uv.y = uv.y / f.b.h + 0.5;
                    }
                }
                    
            } else {
                for (i = 0; i < geo.faces.length ; i++) {
                    geo.faceVertexUvs[0].push([]);
                    for(j = 0; j < 4; j++) {
                        vt = null;
                        if(j == 0) vt = geo.vertices[geo.faces[i].a];   
                        if(j == 1) vt = geo.vertices[geo.faces[i].b];   
                        if(j == 2) vt = geo.vertices[geo.faces[i].c];   
                        if(j == 3 && geo.faces[i].hasOwnProperty('d')) vt = geo.vertices[geo.faces[i].d];   
                        
                        if(vt) {
                            uv = new THREE.Vector2(vt.x / f.b.w + 0.5, vt.y / f.b.h + 0.5);
                            geo.faceVertexUvs[0][i].push(uv);
                        }
                    }
                }
            }
        }

		
        function initScene() {
			$('#btnnext').click(onBtnNextClicked);
            
		
			f.img.tex = THREE.ImageUtils.loadTexture(f.img.src);
		
            camera = new THREE.OrthographicCamera(-f.b.w / 2, +f.b.w / 2, +f.b.h / 2, -f.b.h / 2, -256 / 2, +256 / 2);
            scene = new THREE.Scene();
            container = document.createElement('div');
            document.body.appendChild(container);

            renderer = new THREE.CanvasRenderer();
            //renderer = new THREE.WebGLRenderer({antialias: true});
            //renderer.setSize(f.b.w, f.b.h);
            renderer.setSize(512, 512);
            container.appendChild(renderer.domElement);


            $('canvas').mousemove(onMouseMoveLog);
            
			stats('grid');
        }
		
		function stats(s) {
			var i, j, k;
			if(s == st) return;
			
			if(st == 'grid') {
				$('canvas').off('onMouseDown', onMouseDown);
				$('canvas').off('onMouseMove', onMouseMove);
				$('canvas').off('onMouseUp', onMouseUp);
				$('canvas').off('onMouseOut', onMouseOut);
				
				scene.remove(f.fc.bgmesh);
				
				for(i = 0 ; i < f.fc.xgl.length ; i++) 
					scene.remove(f.fc.xgl[i]);
					
				for(i = 0 ; i < f.fc.ygl.length ; i++) 
					scene.remove(f.fc.ygl[i]);
                
                
                f.fc.updateGridData();
			}
			
			st = s;
			if(st == 'grid') {
				f.fc.updateGrid();
				scene.add(f.fc.bgmesh);
				
				for(i = 0 ; i < f.fc.xgl.length ; i++) {
					scene.add(f.fc.xgl[i]);
					f.fc.xgl[i].geometry.computeBoundingSphere();
				}
				for(i = 0 ; i < f.fc.ygl.length ; i++) {
					scene.add(f.fc.ygl[i]);
					f.fc.ygl[i].geometry.computeBoundingSphere();
				}	
				$('canvas').mousedown(onMouseDown);
				$('canvas').mousemove(onMouseMove);
				$('canvas').mouseup(onMouseUp);
				$('canvas').mouseleave(onMouseOut);	

				$('#instruction').html(
					"<p>Adjust grid lines to fit the face components.</p>" +
					"<ul>" +
					"<li style='color:#55ff55;'>Green : Mouth</li>" +
					"<li style='color:#ff5555;'>Red : Eyes</li>" +
					"<li style='color:#000000;'>Black : Nose</li>" +
					"<li style='color:#5555ff;'>Blue : Face</li>" +
					"</ul>" +
					"<br>" +
					"<br>"
				);
				
			} else if(st == 'face') {
				
				f.fc.updateMesh();
				scene.add(f.fc.mesh);
				scene.add(f.fc.dbmesh);
				f.fc.mesh.geometry.computeBoundingSphere();
				$('#instruction').html(
                    "   "
				);
			}
		
		}
		
        function onMouseMoveLog(event) {
            j2t(event.pageX, event.pageY);
            x = j2tp.x;
            y = j2tp.y;

            $('#log').html(sprintf("(%.1f, %.1f)", x, y));
        }
        
		function onBtnNextClicked(event) {
			if(st == 'grid') stats('face');
		}
		
        
        var cvs;
        var cvsw;
        var cvsh;
        var ftw;
        var fth;
        var j2tp = new THREE.Vector3();
        function j2t(jx, jy) {
            if(cvs == null) {
                cvs = $('canvas');
                cvsw = cvs.width();
                cvsh = cvs.height();
                ftw = f.b.w;
                fth = f.b.h;                
            }
			j2tp.x = (jx - cvs[0].offsetLeft - cvsw/2) * ftw / cvsw;
			j2tp.y = -(jy - cvs[0].offsetTop - cvsh/2) * fth / cvsh;
            return j2tp;
        }
        
        var seltol = 6;
        var sellb=new THREE.Vector3();
        var selub=new THREE.Vector3();
        
        var dmlimit = 6;
		var mdown = 0;
		var mline;
		var lastm = new THREE.Vector2();
		var currm = new THREE.Vector2();
        

        
		function onMouseDown(event) {
            var cvs = $('canvas');
            var cvsw = cvs.width();
            var cvsh = cvs.height();
            var ftw = f.b.w;
            var fth = f.b.h;
            
			mdown = 1; 
			
            j2t(event.pageX, event.pageY);
            currm.set(j2tp.x, j2tp.y);
            
            
			var lx = f.fc.tlx;
			var ly = f.fc.tly;
			
            
            j2t(event.pageX-seltol, event.pageY-seltol);
            sellb.set(j2tp.x, j2tp.y, 0);

            j2t(event.pageX+seltol, event.pageY+seltol);
            selub.set(j2tp.x, j2tp.y, 0);
            
            var lb, up;
			for(i = 0 ; i < ly.length ; i++) {

                
				if(ly[i] - seltol <= currm.y && currm.y <= ly[i] + seltol) {
                //if(sellb.y <= currm.y && currm.y <= selub.y) {
                    console.log('y:' + sellb.y + ',' + currm.y + ',' + selub.y);
					mline = f.fc.ygl[i];
					lastm.set(currm.x, currm.y);
					return;
				}
			}
			
			for(i = 0 ; i < lx.length ; i++) {
				
                
                if(lx[i] - seltol <= currm.x && currm.x <= lx[i] + seltol) {
                //if(sellb.x <= currm.x && currm.x <= selub.x) {
                    console.log('x:' + sellb.x + ',' + currm.x + ',' + selub.x);
					mline = f.fc.xgl[i];
					lastm.set(currm.x, currm.y);
					return;
				}
			}
		}
		
		function onMouseUp(event) {
			mdown = 0;
			mline = null;
		}
		function onMouseOut(event) {
			mdown = 0;
			mline = null;
		}
        
        

		function onMouseMove(event) {
			
            if(!mdown || mline == null) return;
            
            var cvs = $('canvas');
            var cvsw = cvs.width();
            var cvsh = cvs.height();
            var ftw = f.b.w;
            var fth = f.b.h;
            
            j2t(event.pageX, event.pageY);
            currm.set(j2tp.x, j2tp.y);
            
			var dm = new THREE.Vector2(currm.x-lastm.x, currm.y-lastm.y);
			var dmin;
			var dmax;
            var lx = f.fc.tlx;
            var ly = f.fc.tly;
            
            
        
			if(mline.userData.ax == 'x') {	
				dmin = mline.userData.i == 0 ? -f.b.w/2 : (lx[mline.userData.i - 1] + dmlimit);
				dmax = mline.userData.i == lx.length - 1 ? +f.b.w/2 : (lx[mline.userData.i + 1] - dmlimit);
				lx[mline.userData.i] = clamp(lx[mline.userData.i] + dm.x, dmin, dmax);
			} else if(mline.userData.ax == 'y') {
				dmin = mline.userData.i == 0 ? -f.b.h/2 : (ly[mline.userData.i - 1] + dmlimit);
				dmax = mline.userData.i == ly.length - 1 ? +f.b.h/2 : (ly[mline.userData.i + 1] - dmlimit);
				ly[mline.userData.i] = clamp(ly[mline.userData.i] + dm.y, dmin, dmax);
			}
			f.fc.updateGrid();
			
			lastm.set(currm.x, currm.y);
		}
        
        function animate() {
            requestAnimationFrame(animate);
            renderer.render(scene, camera);
        }
    </script>

</html>